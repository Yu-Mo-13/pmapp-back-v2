name: Code Quality & Review

on:
  # push:
  #   branches: [ develop ]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ '**' ]

jobs:
  code-quality:
    name: Code Quality & Static Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || !github.event.pull_request.draft
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, pgsql
        tools: phpstan, phpcs
        coverage: xdebug

    - name: Setup ReviewDog (PR only)
      if: github.event_name == 'pull_request'
      uses: reviewdog/action-setup@v1
      with:
        reviewdog_version: latest

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-8.2-quality-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-8.2-quality-

    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Setup Laravel
      run: |
        php -r "file_exists('.env') || copy('.env.example', '.env');"
        php artisan key:generate
        mkdir -p bootstrap/cache
        php artisan config:cache

    - name: Get changed files (PR only)
      if: github.event_name == 'pull_request'
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          **/*.php
        separator: " "

    # === PHPCS (Code Style) ===
    - name: Run PHPCS (Push - Full scan)
      if: github.event_name == 'push'
      run: |
        php -d error_reporting="E_ERROR | E_WARNING | E_PARSE" vendor/bin/phpcs --report=github --standard=PSR12

    - name: Run PHPCS with ReviewDog (PR - Changed files only)
      if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Running PHPCS on changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
        echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | \
        xargs php -d error_reporting="E_ERROR | E_WARNING | E_PARSE" vendor/bin/phpcs --report=checkstyle -q > phpcs-changed.xml || true
        if [ -s phpcs-changed.xml ]; then
          reviewdog -f=checkstyle -name="Code Style (PHPCS)" -reporter=github-pr-review -level=warning \
            -filter-mode=diff_context -diff="git diff origin/${{ github.base_ref }}...HEAD" < phpcs-changed.xml
        else
          echo "✅ No PHPCS issues found in changed files"
        fi

    # === PHPStan/Larastan (Static Analysis) ===
    - name: Run PHPStan (Push - Full analysis)
      if: github.event_name == 'push'
      run: |
        composer run larastan -- --error-format=github --no-progress

    - name: Run PHPStan with ReviewDog (PR)
      if: github.event_name == 'pull_request'
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        composer run larastan -- --error-format=checkstyle --no-progress > phpstan-analysis.xml || true
        if [ -s phpstan-analysis.xml ]; then
          reviewdog -f=checkstyle -name="Static Analysis (PHPStan)" -reporter=github-pr-review -level=error \
            -filter-mode=diff_context -diff="git diff origin/${{ github.base_ref }}...HEAD" < phpstan-analysis.xml
        else
          echo "✅ No PHPStan issues found"
        fi

    # === Security Analysis ===
    - name: Security Analysis (Composer Audit)
      continue-on-error: true
      run: |
        echo "🔍 Running security audit..."
        composer audit --format=plain || echo "⚠️ Security audit completed with warnings"

    # === Results Summary ===
    - name: Upload Analysis Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-results-${{ github.run_number }}
        path: |
          phpcs-changed.xml
          phpstan-analysis.xml
        retention-days: 7

    - name: Generate Code Quality Report
      if: always()
      run: |
        echo "## 📊 Code Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ github.event_name }}" = "push" ]; then
          echo "### Push to \`${{ github.ref_name }}\` - Full Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Full PHPCS code style check completed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Full PHPStan static analysis completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### Pull Request Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Incremental PHPCS check on changed files" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ PHPStan analysis with ReviewDog integration" >> $GITHUB_STEP_SUMMARY
          echo "- 💬 Check PR comments for detailed feedback" >> $GITHUB_STEP_SUMMARY
        fi

        echo "- 🔐 Security audit completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
